services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: "publish_assist_api"
    environment:
      # Mongo
      DATABASE_HOST: "mongodb://admin:password@mongo:27017"
      DATABASE_NAME: "publish_assist"

      # Qdrant (local)
      USE_QDRANT_CLOUD: "false"
      QDRANT_DATABASE_HOST: "qdrant"
      QDRANT_DATABASE_PORT: "6333"

      # Optional keys
      GROQ_API_KEY: "${GROQ_API_KEY:-}"

    ports:
      - "8000:8000"
    command: >
      sh -c "uvicorn api.main:app --host 0.0.0.0 --port 8000"
    depends_on:
      - mongo
      - qdrant
    networks:
      - local
    restart: always

  mongo:
    image: mongo:latest
    container_name: "publish_assist_mongo"
    logging:
      options:
        max-size: 1g
    environment:
      MONGO_INITDB_ROOT_USERNAME: "admin"
      MONGO_INITDB_ROOT_PASSWORD: "password"
    ports:
      - 27017:27017
    volumes:
      - mongo_data:/data/db
    networks:
      - local
    restart: always

  qdrant:
    image: qdrant/qdrant:latest
    container_name: "publish_assist_qdrant"
    ports:
      - 6333:6333
      - 6334:6334
    expose:
      - 6333
      - 6334
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - local
    restart: always

volumes:
  mongo_data:
  qdrant_data:

networks:
  local:
    driver: bridge
